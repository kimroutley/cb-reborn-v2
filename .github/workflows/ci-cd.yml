# Club Blackout Reborn - CI/CD Configuration

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  FLUTTER_VERSION: '3.38.7'

jobs:
  # ── Code Quality ──
  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          
      - name: Install Dependencies
        run: |
          cd packages/cb_logic && flutter pub get
          cd ../cb_models && flutter pub get
          cd ../cb_theme && flutter pub get
          cd ../cb_comms && flutter pub get
          cd ../../apps/host && flutter pub get
          cd ../player && flutter pub get
          
      - name: Generate Code
        run: |
          cd packages/cb_models
          dart run build_runner build --delete-conflicting-outputs
          cd ../cb_logic
          dart run build_runner build --delete-conflicting-outputs
          
      - name: Run Analyzer
        run: |
           cd packages/cb_logic && flutter analyze
           cd ../cb_models && flutter analyze
           cd ../cb_theme && flutter analyze
           cd ../cb_comms && flutter analyze
        
      - name: Check Formatting
        run: |
           dart format --set-exit-if-changed packages/cb_logic
           dart format --set-exit-if-changed packages/cb_models
           dart format --set-exit-if-changed packages/cb_theme
           dart format --set-exit-if-changed packages/cb_comms

  # ── Unit Tests ──
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          
      - name: Install Dependencies
        run: |
          cd packages/cb_logic
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs
          
      - name: Run Tests
        run: |
          cd packages/cb_logic
          flutter test --coverage
          
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./packages/cb_logic/coverage/lcov.info

  # ── Build Web ──
  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          
      - name: Install Dependencies
        run: |
          cd packages/cb_logic && flutter pub get
          cd ../cb_models && flutter pub get
          cd ../cb_theme && flutter pub get
          cd ../cb_comms && flutter pub get
          cd ../../apps/player && flutter pub get
          
      - name: Generate Code
        run: |
          cd packages/cb_models
          dart run build_runner build --delete-conflicting-outputs
          cd ../cb_logic
          dart run build_runner build --delete-conflicting-outputs
          
      - name: Build Web
        run: |
          cd apps/player
          flutter build web --release
          
      - name: Upload Web Artifact
        uses: actions/upload-artifact@v3
        with:
          name: web-build
          path: apps/player/build/web

  # ── Deploy to Firebase ──
  deploy-firebase:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    needs: build-web
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Download Web Artifact
        uses: actions/download-artifact@v3
        with:
          name: web-build
          path: apps/player/build/web
          
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
          
      - name: Deploy Firestore Rules
        run: |
          npm install -g firebase-tools
          firebase deploy --only firestore:rules --token ${{ secrets.FIREBASE_TOKEN }}

  # ── Build Android ──
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          
      - name: Install Dependencies
        run: |
          cd apps/player && flutter pub get
          
      - name: Build APK
        run: |
          cd apps/player
          flutter build apk --release
          
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: android-apk
          path: apps/player/build/app/outputs/flutter-apk/app-release.apk

  # ── Build iOS ──
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          
      - name: Install Dependencies
        run: |
          cd apps/player && flutter pub get
          
      - name: Build iOS
        run: |
          cd apps/player
          flutter build ios --release --no-codesign
          
      - name: Upload iOS Build
        uses: actions/upload-artifact@v3
        with:
          name: ios-build
          path: apps/player/build/ios/iphoneos

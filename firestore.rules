rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ── Helper Functions ──
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isValidGameData() {
      return request.resource.data.keys().hasAll(['phase', 'players', 'dayCount'])
        && request.resource.data.phase is string
        && request.resource.data.players is list
        && request.resource.data.dayCount is number;
    }
    
    function isValidJoinRequest() {
      return request.resource.data.keys().hasAll(['name', 'timestamp'])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 50;
    }
    
    function isValidAction() {
      return request.resource.data.keys().hasAll(['stepId', 'playerId', 'timestamp'])
        && request.resource.data.stepId is string
        && request.resource.data.playerId is string;
    }
    
    // ── Games Collection ──
    match /games/{joinCode} {
      
      // Anyone can read the public game state (needed for players to join and see updates)
      allow read: if true;
      
      // Host can create/update/delete games
      allow write: if isAuthenticated() && isValidGameData() && (
        (!exists(resource) && request.resource.data.hostId == request.auth.uid) ||
        (exists(resource) && resource.data.hostId == request.auth.uid)
      );
      
      // ── Join Requests Subcollection ──
      match /joins/{joinId} {
        // Anyone can create a join request with valid data
        allow create: if isValidJoinRequest() && isAuthenticated();
        
        // Host can read and delete join requests
        allow read, delete: if isAuthenticated();
        
        // No updates allowed (join requests are immutable)
        allow update: if false;
      }
      
      // ── Player Actions Subcollection ──
      match /actions/{actionId} {
        // Players can submit actions with valid data
        allow create: if isValidAction() && isAuthenticated();
        
        // Host can read actions
        allow read: if isAuthenticated();
        
        // No updates or deletes (actions are immutable history)
        allow update, delete: if false;
      }
      
      // ── Private Player State Subcollection ──
      match /private_state/{playerId} {
        // Only authenticated host or the owning player can read private state
        allow read: if isAuthenticated() && (
          request.auth.uid == resource.data.uid ||
          request.auth.uid == get(/databases/$(database)/documents/games/$(joinCode)).data.hostId
        );

        // Only authenticated host can write private state
        allow write: if isAuthenticated() &&
          request.auth.uid == get(/databases/$(database)/documents/games/$(joinCode)).data.hostId;
      }
      
      // ── Chat Messages Subcollection ──
      match /chat/{messageId} {
        // Anyone in the game can read chat messages
        allow read: if true;
        
        // Anyone can create chat messages (players chatting)
        allow create: if isAuthenticated()
          && request.resource.data.keys().hasAll(['playerId', 'message', 'timestamp'])
          && request.resource.data.message is string
          && request.resource.data.message.size() > 0
          && request.resource.data.message.size() <= 500;
        
        // No updates or deletes (chat is immutable)
        allow update, delete: if false;
      }
    }
    
    // ── Game Records Collection (completed games history) ──
    match /game_records/{recordId} {
      // Host can read their own game records
      allow read: if isAuthenticated();
      
      // Host can create game records
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['winner', 'endedAt', 'playerCount']);
      
      // No updates or deletes (records are immutable)
      allow update, delete: if false;
    }
    
    // ── Games Night Records Collection ──
    match /games_nights/{nightId} {
      // Host can read their own games night records
      allow read: if isAuthenticated();
      
      // Host can create and update games night records
      allow create, update: if isAuthenticated()
        && request.resource.data.keys().hasAll(['startedAt', 'gameIds']);
      
      // Host can delete their own records
      allow delete: if isAuthenticated();
    }

    // ── User Profiles Collection (Moniker Gate) ──
    match /user_profiles/{uid} {
      // Users can read/write only their own profile document.
      allow read, create, update: if isAuthenticated() && request.auth.uid == uid;

      // Prevent client-side profile deletes.
      allow delete: if false;
    }
  }
}
